@inherits LayoutComponentBase
@inject ERP.Blazor.Services.SesionService SesionService

@inject ERP.Blazor.Services.NotificacionService NotificacionesService
@inject NavigationManager Nav


<div class="all-container2">
    <!-- Header -->
    <header class="main-header">
        <div class="logo">GanadApp ERP <span>System</span></div>
        <!-- BOT√ìN MEN√ö M√ìVIL -->
        <button class="menu-toggle" @onclick="ToggleMenu">
            <svg xmlns="http://www.w3.org/2000/svg" width="30" height="25" fill="white" viewBox="0 0 16 16">
                <path fill-rule="evenodd"
                    d="M1.5 12a.5.5 0 0 1 0-1h13a.5.5 0 0 1 0 1h-13zm0-4a.5.5 0 0 1 0-1h13a.5.5 0 0 1 0 1h-13zm0-4a.5.5 0 0 1 0-1h13a.5.5 0 0 1 0 1h-13z" />
            </svg>
        </button>

        @if (mostrarMenuMovil)
        {
            <div class="menu-movil">
                <a href="/">Inicio</a>
                <a href="/configperfil">Perfil</a>
                <a @onclick="ToggleNotificaciones" class="notificaciones-btn relative">Notificaciones</a>
                <a @onclick="()=> mostrarModalclosesesion = true">Cerrar sesi√≥n</a>
            </div>
        }
        <nav class="top-nav">

        <!-- BOTON TOPNAV IR A BIENVENIDA -->
        <a href="/" class="btn-header btn-outline logohouse" id="logohouse"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="20" fill="currentColor" class="bi bi-file-fill" viewBox="0 0 16 16">
             <path fill-rule="evenodd" d="M4 0h8a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2"/></svg>
        </a>
        <!-- BOTON TOPNAV IR A PERFIL -->
        <a href="/configperfil"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="20" fill="currentColor" class="bi bi-person-fill" viewBox="0 0 16 16">
            <path d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6"/></svg>
        </a>
        <!-- BOTON TOPNAV IR A NOTIFICACIONES -->
        <a @onclick="ToggleNotificaciones" class="notificaciones-btn relative"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="20" fill="currentColor" class="bi bi-bell-fill" viewBox="0 0 16 16">
            <path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2m.995-14.901a1 1 0 1 0-1.99 0A5 5 0 0 0 3 6c0 1.098-.5 6-2 7h14c-1.5-1-2-5.902-2-7 0-2.42-1.72-4.44-4.005-4.901"/></svg>
        </a>
        @if (hayNotificacionesNuevas)
        {
            <span class="badge-notificacion"></span>
        }
        @if (mostrarNotificaciones)
        {
            <div class="notificaciones-modal">
                <div class="modal-header">
                    <h4>Notificaciones</h4>
                    <button class="close-btn" @onclick="ToggleNotificaciones">√ó</button>
                </div>
                <div class="modal-body">
                    <!-- üîò Bot√≥n nuevo: Eliminar todas -->
                    <button class="dropdown-item text-danger text-center fw-bold"
                            @onclick="EliminarTodasNotificaciones">
                        <i class="bi bi-trash"></i> Eliminar todas
                    </button>
                    @if (notificaciones.Count == 0)
                    {
                        <p>No tienes notificaciones nuevas.</p>
                    }
                    else
                    {
                        <ul>
                            @foreach (var n in notificaciones)
                            {
                                <li>
                                    @n
                                    <button class="btn-eliminar" @onclick="() => EliminarNotificacion(n)">√ó</button>
                                </li>
                            }
                        </ul>
                        
                    }
                </div>
            </div>
        }
        <!-- BOTON TOPNAV CERRAR SESION -->
        <a @onclick="()=> mostrarModalclosesesion = true"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="20" fill="currentColor" class="bi bi-box-arrow-left" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M6 12.5a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-9a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v2a.5.5 0 0 1-1 0v-2A1.5 1.5 0 0 1 6.5 2h8A1.5 1.5 0 0 1 16 3.5v9a1.5 1.5 0 0 1-1.5 1.5h-8A1.5 1.5 0 0 1 5 12.5v-2a.5.5 0 0 1 1 0z"/>
            <path fill-rule="evenodd" d="M.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L1.707 7.5H10.5a.5.5 0 0 1 0 1H1.707l2.147 2.146a.5.5 0 0 1-.708.708z"/></svg>
        </a>
        @if (mostrarModalclosesesion)
        {
            <div class="modal-closesesion">
                <div class="closesesion-container">
                    <h2>¬øDeseas cerrar sesi√≥n?</h2>
                    <p>Tu sesi√≥n actual se cerrar√° y deber√°s volver a iniciar sesi√≥n.</p>

                    <div class="modal-buttons">
                        <button class="btn-modal" @onclick="()=> mostrarModalclosesesion = false">Cancelar</button>
                        <button class="btn-modal2" @onclick="CerrarSesion">Cerrar sesi√≥n</button>
                    </div>
                </div>
            </div>
        }
        </nav>
    </header>

    <!-- Layout -->
    <div class="layout">
    <!-- BOT√ìN BARRA M√ìVIL -->
    <button class="sidebar-toggle" @onclick="ToggleSidebar">
        <svg xmlns="http://www.w3.org/2000/svg" width="30" height="25" fill="white" viewBox="0 0 16 16">
            <path fill-rule="evenodd"
                d="M1.5 12a.5.5 0 0 1 0-1h13a.5.5 0 0 1 0 1h-13zm0-4a.5.5 0 0 1 0-1h13a.5.5 0 0 1 0 1h-13zm0-4a.5.5 0 0 1 0-1h13a.5.5 0 0 1 0 1h-13z" />
        </svg>
    </button>

    @if (mostrarSidebarMovil)
    {
        <div class="sidebar-overlay" @onclick="ToggleSidebar"></div>
    }
    <aside class="sidebar" style="@(mostrarSidebarMovil ? "left: 0;" : "left: -100%;")">
        <nav>
            <ul>
                <li><NavLink href="/home" Match="NavLinkMatch.All" activeClass="active">Inicio</NavLink></li>
                <li><NavLink href="/metricas" Match="NavLinkMatch.All" activeClass="active">Metricas</NavLink></li>
                    <li>
                <div class="menu-item @(menuInventarioActivo ? "active" : "")" @onclick="ToggleInventario">
                    <span>Inventario</span>
                    <i class="fas fa-chevron-down flecha @(mostrarInventario ? "abierta" : "")"></i>
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="25" fill="currentColor" class="bi bi-caret-down-fill" viewBox="0 0 16 16">
                        <path d="M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z"/>
                    </svg>
                </div>

                @if (mostrarInventario)
                {
                    <ul class="submenu">
                        <li><NavLink href="/inventario-medicamentos" activeClass="active">Medicamentos</NavLink></li>
                        <li><NavLink href="/proveedores" activeClass="active">Proveedores</NavLink></li>
                        <li><NavLink href="/Ganado" activeClass="active">Ganado</NavLink></li>
                        <li><NavLink href="/veterinarios" activeClass="active">Veterinarios</NavLink></li>
                    </ul>
                }
            </li>
                <li><NavLink href="/usuarios" Match="NavLinkMatch.All" activeClass="active">Usuarios</NavLink></li>
            </ul>
        </nav>
    </aside>

    <main class="main-content">
        @Body
    </main>
</div>

    <!-- Footer -->
    <footer class="main-footer">
        <p>¬© 2025 GanadApp. Todos los derechos reservados.</p>
    </footer>
</div>

@if (!string.IsNullOrEmpty(mensaje))
{
    <div class="toast-message @toastClass">
        @mensaje
    </div>
}


@code {
    private bool mostrarModalclosesesion = false;
    private bool menuInventarioActivo = false;
    private bool mostrarMenuMovil = false;
    private bool mostrarSidebarMovil = false;

    private bool mostrarInventario = false;



    private bool hayNotificacionesNuevas => notificaciones.Any();
    private System.Threading.Timer? _timer;
    private int indiceNotificacionActual = 0;
    private readonly Random random = new();
    private const string claveNotificacionesDia = "notificaciones_enviadas_hoy";
    private List<string> notificacionesEnviadasHoy = new();
    private TimeSpan intervaloNotificacion = TimeSpan.FromSeconds(15);



    private bool mostrarNotificaciones = false;
    private List<string> notificaciones = new();

    private string mensaje = "";
    private string toastClass = "";

    protected override async Task OnInitializedAsync()
    {
        notificaciones = await NotificacionesService.ObtenerAsync();

        // Bienvenida: usa AgregarAsync (no duplicar√°)
        bool bienvenidaYaMostrada = await NotificacionesService.ObtenerBanderaAsync("bienvenida_mostrada");
        if (!bienvenidaYaMostrada)
        {
            await NotificacionesService.AgregarAsync("üëã Bienvenido al sistema GanadApp ERP.");
            MostrarNotificacion("Bienvenido a GanadApp ERP", "success");
            await NotificacionesService.GuardarBanderaAsync("bienvenida_mostrada", true);
        }

        // Inicializar lista local (asegura estados √∫nicos)
        notificaciones = (await NotificacionesService.ObtenerAsync()).Distinct().ToList();

        // Control diario: si no se generaron hoy, arrancar timer o generar
        string fechaHoy = DateTime.Now.ToString("yyyy-MM-dd");
        string ultimaFecha = await NotificacionesService.ObtenerUltimaNotificacionFechaAsync(claveNotificacionesDia);
        if (ultimaFecha != fechaHoy)
        {
            indiceNotificacionActual = 0;
            notificacionesEnviadasHoy.Clear();
            await NotificacionesService.GuardarUltimaNotificacionFechaAsync(claveNotificacionesDia);
        }

        _iniciarTimerNotificaciones();
    }

    private void _iniciarTimerNotificaciones()
    {
        if (_timer != null)
            return; // Evita duplicar timers

         var delayInicial = TimeSpan.FromSeconds(random.Next(30, 60)); //üü©üü©
        _timer = new System.Threading.Timer(async _ =>
        {
            await EnviarNotificacionPeriodica();
        },
        null,
        delayInicial,   // ‚è± Primer disparo aleatorio
        Timeout.InfiniteTimeSpan // Luego manejamos manualmente los tiempos
        );      // Luego se repite
    }

    private async Task EnviarNotificacionPeriodica()
    {
        try
        {
            if (indiceNotificacionActual >= notificacionesPredeterminadas.Count)
            {
                _timer?.Change(Timeout.Infinite, 0);
                return;
            }

            string nueva = notificacionesPredeterminadas[indiceNotificacionActual];

            // Evitar duplicados del mismo d√≠a
            if (!notificacionesEnviadasHoy.Contains(nueva))
            {
                notificaciones.Add(nueva);
                notificacionesEnviadasHoy.Add(nueva);

                await NotificacionesService.GuardarAsync(notificaciones);
                MostrarNotificacion(nueva, "success");
            }

            indiceNotificacionActual++;

            // ‚è± Calcular un nuevo tiempo aleatorio entre 1 y 5 minutos
            var siguienteIntervalo = TimeSpan.FromMinutes(random.Next(2, 10));  //üü©üü©

            // Reiniciar el timer con ese intervalo
            _timer?.Change(siguienteIntervalo, Timeout.InfiniteTimeSpan);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error en notificaciones autom√°ticas: {ex.Message}");
        }
    }

    private readonly List<string> notificacionesPredeterminadas = new()
    {
        "üìû L√≠nea de atenci√≥n al cliente: +57 300 538 6979",
        "üí° Descubre nuevas funciones en GanadApp: m√°s control, m√°s productividad",
        "üì∞ Novedades GanadApp: actualizaci√≥n de m√≥dulo de inventario",
        "‚úÖ Consejo: revisa las m√©tricas semanalmente para mantener tus datos al d√≠a",
        "üéØ Recuerda mantener tu sesi√≥n segura: cierra al finalizar tu jornada",
        "üå± Cada dato cuenta. ¬°Organiza tu ganado y crece con GanadApp!",
        "üöÄ Tu esfuerzo impulsa la innovaci√≥n. ¬°Sigue adelante!",
        "üíö En GanadApp creemos en el progreso diario. Peque√±os pasos, grandes resultados.",
        "üìä ¬øSab√≠as que puedes analizar tus ventas por mes? Explora el panel de reportes.",
        "üß© Optimiza tu inventario: revisa los productos pr√≥ximos a vencer.",
        "üí¨ ‚ÄòEl √©xito es la suma de peque√±os esfuerzos repetidos d√≠a tras d√≠a.‚Äô ‚Äì GanadApp",
        "üî• ¬°Mant√©n tus registros al d√≠a y evita sorpresas! GanadApp te acompa√±a.",
        "üåü Consejo del d√≠a: usa el m√≥dulo de reportes para detectar tendencias positivas."
    };

    private void ToggleNotificaciones() => mostrarNotificaciones = !mostrarNotificaciones;

    private async Task EliminarNotificacion(string n)
    {
        await NotificacionesService.EliminarAsync(n);
        notificaciones.Remove(n);
    }

    private async Task EliminarTodasNotificaciones()
    {
        notificaciones.Clear();
        await NotificacionesService.LimpiarAsync();
        StateHasChanged();
    }

    private async Task CerrarSesion()
    {
        await SesionService.CerrarSesionAsync();
        await NotificacionesService.EliminarClaveAsync("bienvenida_mostrada");
        _timer?.Dispose();
        _timer = null;
        Nav.NavigateTo("/", forceLoad: true);
    }

    private void ToggleInventario()
    {
        mostrarInventario = !mostrarInventario;
        menuInventarioActivo = !menuInventarioActivo;
    }

    private void ToggleMenu()
    {
        mostrarMenuMovil = !mostrarMenuMovil;
    }

    private void ToggleSidebar()
    {
        mostrarSidebarMovil = !mostrarSidebarMovil;
    }

    // ‚úÖ M√©todo de toast (temporal en pantalla)
    private async void MostrarNotificacion(string texto, string tipo)
    {
        mensaje = texto;
        toastClass = tipo;
        StateHasChanged();

        await Task.Delay(4000);
        mensaje = "";
        StateHasChanged();
    }
}