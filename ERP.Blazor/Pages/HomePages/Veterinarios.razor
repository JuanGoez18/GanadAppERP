@page "/veterinarios"
@layout MainLayout
@using ERP.Blazor.Models
@inject ERP.Blazor.Services.VeterinariosService VeterinariosService
@inject ERP.Blazor.Services.SesionService SesionService
@inject NavigationManager Nav

<PageTitle>Veterinarios</PageTitle>

@if (!sesionVerificada)
{
    <div class="modal-nosesion">
        <div class="nosesion-container">
            <h2>Sesión no activa</h2>
            <p>Debes iniciar sesión primero.</p>
            <button class="btn-modal" @onclick="VolverABienvenida">Volver</button>
        </div>
    </div>
}
else
{
    <div class="auth-container2">
        <div class="auth-card2">
            <h1 class="main-title">Gestión de Veterinarios</h1>
            <p class="module-description">Administra los veterinarios registrados en el sistema ERP.</p>

            <div class="search-bar">
                <input type="text" placeholder="Buscar veterinario..." @bind="filtro" />
                <button class="btn btn-secondary" @onclick="BuscarVeterinarios">Buscar</button>
                <button class="btn btn-primary" @onclick="AbrirModalNuevo">+ Nuevo Veterinario</button>
            </div>

            <table class="usuarios-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Apellido</th>
                        <th>Edad</th>
                        <th>C.C.</th>
                        <th>Sexo</th>
                        <th>Dirección</th>
                        <th>Teléfono</th>
                        <th>Entidad</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @if (cargando)
                    {
                        <tr><td colspan="10" class="text-center">Cargando veterinarios...</td></tr>
                    }
                    else if (veterinarios == null || veterinarios.Count == 0)
                    {
                        <tr><td colspan="10" class="text-center">No se encontraron veterinarios.</td></tr>
                    }
                    else
                    {
                        @foreach (var v in veterinarios.Where(x => x.Estado))
                        {
                            <tr>
                                <td>@v.IdVeterinarios</td>
                                <td>@v.Nombre</td>
                                <td>@v.Apellido</td>
                                <td>@v.Edad</td>
                                <td>@v.CC</td>
                                <td>@v.Sexo</td>
                                <td>@v.Direccion</td>
                                <td>@v.Telefono</td>
                                <td>@v.Entidad</td>
                                <td>
                                    <button class="btn btn-sm btn-info" @onclick="() => EditarVeterinario(v)">Editar</button>
                                    <button class="btn btn-sm btn-danger" @onclick="() => ConfirmEliminar(v.IdVeterinarios)">Eliminar</button>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
}

@if (mostrarModal)
{
    <div class="modal-nuevousuario-over">
        <div class="modal-nuevousuario">
            <h3>@(veterinarioEditando == null ? "Nuevo Veterinario" : "Editar Veterinario")</h3>

            @if (!string.IsNullOrEmpty(mensajeError))
            {
                <div class="alert alert-danger">@mensajeError</div>
            }

            <div class="modal-nuevousuario-body">
                <label>Nombre</label>
                <input type="text" class="form-control" @bind="form.Nombre" />

                <label>Apellido</label>
                <input type="text" class="form-control" @bind="form.Apellido" />

                <label>Edad</label>
                <input type="number" class="form-control" @bind="form.Edad" min="1" />

                <label>C.C.</label>
                <input type="text" class="form-control" @bind="form.CC" />

                <label>Sexo</label>
                <input type="text" class="form-control" @bind="form.Sexo" />

                <label>Dirección</label>
                <input type="text" class="form-control" @bind="form.Direccion" />

                <label>Teléfono</label>
                <input type="text" class="form-control" @bind="form.Telefono" />

                <label>Entidad</label>
                <input type="text" class="form-control" @bind="form.Entidad" />
            </div>

            <div class="modal-nuevousuario-footer">
                <button class="btn btn-secondary" @onclick="CerrarModal">Cancelar</button>
                <button class="btn btn-success" @onclick="GuardarVeterinario">Guardar</button>
            </div>
        </div>
    </div>
}

@code {
    private List<VeterinarioDTO> veterinarios = new();
    private VeterinarioDTO form = new VeterinarioDTO();
    private VeterinarioDTO? veterinarioEditando;
    private bool mostrarModal = false;
    private string filtro = string.Empty;
    private bool sesionVerificada = true;
    private bool cargando = true;
    private string mensajeError = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await VerificarSesionAsync();
        await CargarVeterinariosAsync();
    }

    private async Task VerificarSesionAsync()
    {
        try
        {
            sesionVerificada = await SesionService.HaySesionAsync();
        }
        catch
        {
            sesionVerificada = false;
        }
    }

    private async Task CargarVeterinariosAsync()
    {
        try
        {
            cargando = true;
            veterinarios = await VeterinariosService.ObtenerVeterinariosAsync();
            veterinarios = veterinarios.Where(x => x.Estado).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error cargando veterinarios: {ex.Message}");
            veterinarios = new List<VeterinarioDTO>();
        }
        finally
        {
            cargando = false;
        }
    }

    private async Task BuscarVeterinarios()
    {
        try
        {
            cargando = true;
            var lista = await VeterinariosService.ObtenerVeterinariosAsync();

            if (!string.IsNullOrWhiteSpace(filtro))
                veterinarios = lista.Where(v => v.Nombre.Contains(filtro, StringComparison.OrdinalIgnoreCase)
                    || v.Apellido.Contains(filtro, StringComparison.OrdinalIgnoreCase)
                    || v.Entidad.Contains(filtro, StringComparison.OrdinalIgnoreCase)).ToList();
            else
                veterinarios = lista;

            veterinarios = veterinarios.Where(x => x.Estado).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error buscando veterinarios: {ex.Message}");
            veterinarios = new List<VeterinarioDTO>();
        }
        finally
        {
            cargando = false;
        }
    }

    private void AbrirModalNuevo()
    {
        veterinarioEditando = null;
        form = new VeterinarioDTO { Estado = true };
        mostrarModal = true;
    }

    private void EditarVeterinario(VeterinarioDTO v)
    {
        veterinarioEditando = v;
        form = new VeterinarioDTO
        {
            IdVeterinarios = v.IdVeterinarios,
            Nombre = v.Nombre,
            Apellido = v.Apellido,
            Edad = v.Edad,
            CC = v.CC,
            Sexo = v.Sexo,
            Direccion = v.Direccion,
            Telefono = v.Telefono,
            Entidad = v.Entidad,
            Estado = v.Estado
        };
        mostrarModal = true;
    }

    private async Task GuardarVeterinario()
    {
        mensajeError = string.Empty;

        if (string.IsNullOrWhiteSpace(form.Nombre) ||
            string.IsNullOrWhiteSpace(form.Apellido) ||
            form.Edad <= 0 ||
            string.IsNullOrWhiteSpace(form.CC) ||
            string.IsNullOrWhiteSpace(form.Sexo) ||
            string.IsNullOrWhiteSpace(form.Direccion) ||
            string.IsNullOrWhiteSpace(form.Telefono) ||
            string.IsNullOrWhiteSpace(form.Entidad))
        {
            mensajeError = "Todos los campos son obligatorios y válidos.";
            return;
        }

        bool ok;

        if (veterinarioEditando == null)
            ok = await VeterinariosService.CrearVeterinarioAsync(form);
        else
            ok = await VeterinariosService.ActualizarVeterinarioAsync(form);

        if (!ok)
        {
            mensajeError = "Error al guardar veterinario.";
            return;
        }

        mostrarModal = false;
        await CargarVeterinariosAsync();
    }

    private async Task ConfirmEliminar(int id)
    {
        var ok = await VeterinariosService.EliminarVeterinarioAsync(id);
        if (!ok)
        {
            mensajeError = "Error al eliminar veterinario.";
            return;
        }

        await CargarVeterinariosAsync();
    }

    private void CerrarModal() => mostrarModal = false;
    private void VolverABienvenida() => Nav.NavigateTo("/", forceLoad: true);
}
